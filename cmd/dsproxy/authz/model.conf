# DSProxy Casbin Authorization Model
# This model defines RBAC with wildcard support for datasource proxy authorization

[request_definition]
# Request format: subject, datasource, cluster/namespace, action
# - subject: User ID from JWT 'sub' claim
# - datasource: Datasource ID from X-Datasource-Uid header
# - cluster/namespace: Resource being accessed
# - action: Operation type (e.g., 'read')
r = sub, dom, obj, act

[policy_definition]
# Policy format matches request format
# Policies are defined in policy.csv
p = sub, dom, obj, act

[role_definition]
# Role inheritance: g, user, role
# Allows users to inherit permissions from roles/groups
g = _, _

[policy_effect]
# Allow if at least one policy matches
e = some(where (p.eft == allow))

[matchers]
# Matching rules:
# 1. Subject matches either directly OR via role inheritance (g function)
# 2. Datasource matches using keyMatch2 (supports wildcards) OR is "*"
# 3. Resource (cluster/namespace) matches using keyMatch2 (supports wildcards) OR is "*"
# 4. Action must match exactly
#
# keyMatch2 supports patterns like:
# - cluster1/namespace* matches cluster1/namespace1, cluster1/namespace2, etc.
# - */dev-* matches any-cluster/dev-frontend, any-cluster/dev-backend, etc.
# - */* matches everything
m = (g(r.sub, p.sub) || r.sub == p.sub) &&
    (keyMatch2(r.dom, p.dom) || p.dom == "*") &&
    (keyMatch2(r.obj, p.obj) || p.obj == "*") &&
    r.act == p.act

